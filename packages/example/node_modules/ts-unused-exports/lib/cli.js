"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runCli = void 0;
var chalk = require("chalk");
var app_1 = require("./app");
var argsParser_1 = require("./argsParser");
var usage_1 = require("./usage");
// eslint style exit code:
var ExitCode;
(function (ExitCode) {
    ExitCode[ExitCode["NoUnusedExportsFound"] = 0] = "NoUnusedExportsFound";
    ExitCode[ExitCode["UnusedExportsFound"] = 1] = "UnusedExportsFound";
    ExitCode[ExitCode["BadArgsOrException"] = 2] = "BadArgsOrException";
})(ExitCode || (ExitCode = {}));
var getLocationInFile = function (location) {
    if (!location) {
        return '';
    }
    return "[" + location.line + "," + location.character + "]";
};
var showMessages = function (files, showMessage, analysis, options) {
    var filesCountMessage = chalk.bold(files.length.toString()) + " module" + (files.length == 1 ? '' : 's') + " with unused exports";
    showMessage(files.length ? chalk.red(filesCountMessage) : filesCountMessage);
    if (options === null || options === void 0 ? void 0 : options.showLineNumber) {
        files.forEach(function (path) {
            analysis[path].forEach(function (unusedExport) {
                showMessage("" + path + getLocationInFile(unusedExport.location) + ": " + chalk.bold.yellow(unusedExport.exportName));
            });
        });
    }
    else {
        files.forEach(function (path) {
            return showMessage(path + ": " + chalk.bold.yellow(analysis[path].map(function (r) { return r.exportName; }).join(', ')));
        });
    }
};
var runCli = function (exitWith, showError, showMessage, _a) {
    var tsconfig = _a[0], tsFiles = _a.slice(1);
    if (!argsParser_1.hasValidArgs(showError, tsconfig, tsFiles)) {
        showError(usage_1.USAGE);
        return exitWith(ExitCode.BadArgsOrException);
    }
    try {
        var analysis_1 = app_1.default(tsconfig, tsFiles.length ? tsFiles : undefined);
        var files = Object.keys(analysis_1);
        var options = argsParser_1.extractOptionsFromFiles(tsFiles).options;
        var hideMessages = (options === null || options === void 0 ? void 0 : options.silent) && files.length === 0;
        if (!hideMessages) {
            showMessages(files, showMessage, analysis_1, options);
        }
        // Max allowed exit code is 127 (single signed byte)
        var MAX_ALLOWED_EXIT_CODE = 127;
        if (options === null || options === void 0 ? void 0 : options.exitWithCount) {
            return exitWith(Math.min(MAX_ALLOWED_EXIT_CODE, files.length));
        }
        else if (options === null || options === void 0 ? void 0 : options.exitWithUnusedTypesCount) {
            var totalIssues = files
                .map(function (f) { return analysis_1[f].length; })
                .reduce(function (previous, current) { return previous + current; }, 0);
            return exitWith(Math.min(MAX_ALLOWED_EXIT_CODE, totalIssues));
        }
        var maxIssues = (options === null || options === void 0 ? void 0 : options.maxIssues) || 0;
        return exitWith(files.length <= maxIssues
            ? ExitCode.NoUnusedExportsFound
            : ExitCode.UnusedExportsFound);
    }
    catch (e) {
        showError(e);
        return exitWith(ExitCode.BadArgsOrException);
    }
};
exports.runCli = runCli;
//# sourceMappingURL=cli.js.map