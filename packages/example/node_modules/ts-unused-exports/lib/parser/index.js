"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var ts = require("typescript");
var tsconfigPaths = require("tsconfig-paths");
var path_1 = require("path");
var export_1 = require("./export");
var import_1 = require("./import");
var comment_1 = require("./comment");
var nodeProcessor_1 = require("./nodeProcessor");
var fs_1 = require("fs");
var extractFilename = function (rootDir, path) {
    var name = path_1.relative(rootDir, path).replace(/([\\/]index)?\.[^.]*$/, '');
    // Imports always have the '.d' part dropped from the filename,
    // so for the export counting to work with d.ts files, we need to also drop '.d' part.
    // Assumption: the same folder will not contain two files like: a.ts, a.d.ts.
    if (!!name.match(/\.d$/)) {
        name = name.substr(0, name.length - 2);
    }
    return name;
};
var mapFile = function (rootDir, path, file, baseUrl, paths, extraOptions) {
    var imports = {};
    var exportNames = [];
    var exportLocations = [];
    var name = extractFilename(rootDir, path);
    var baseDir = path_1.resolve(rootDir, baseUrl);
    var tsconfigPathsMatcher = (!!paths && tsconfigPaths.createMatchPath(baseDir, paths)) || undefined;
    var addImport = function (fw) {
        return import_1.addImportCore(fw, rootDir, path, imports, baseDir, baseUrl, tsconfigPathsMatcher);
    };
    var addExport = function (exportName, node) {
        export_1.addExportCore(exportName, file, node, exportLocations, exportNames, extraOptions);
    };
    ts.forEachChild(file, function (node) {
        if (comment_1.isNodeDisabledViaComment(node, file)) {
            return;
        }
        nodeProcessor_1.processNode(node, path, addImport, addExport, imports, exportNames, extraOptions);
    });
    return {
        path: name,
        fullPath: path,
        imports: imports,
        exports: exportNames,
        exportLocations: exportLocations,
    };
};
var parseFile = function (rootDir, path, baseUrl, paths, extraOptions) {
    return mapFile(rootDir, path, ts.createSourceFile(path, fs_1.readFileSync(path, { encoding: 'utf8' }), ts.ScriptTarget.ES2015, 
    /*setParentNodes */ true), baseUrl, paths, extraOptions);
};
var parsePaths = function (rootDir, _a, extraOptions) {
    var baseUrl = _a.baseUrl, filePaths = _a.files, paths = _a.paths;
    var includeDeclarationFiles = !(extraOptions === null || extraOptions === void 0 ? void 0 : extraOptions.excludeDeclarationFiles);
    var files = filePaths
        .filter(function (p) { return includeDeclarationFiles || !p.includes('.d.'); })
        .map(function (path) {
        return parseFile(rootDir, path_1.resolve(rootDir, path), baseUrl, paths, extraOptions);
    });
    return files;
};
exports.default = (function (rootDir, TsConfig, extraOptions) {
    return parsePaths(rootDir, TsConfig, extraOptions);
});
//# sourceMappingURL=index.js.map